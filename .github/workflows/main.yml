name: VID Scanner

on:
  workflow_dispatch: # 手动触发
  schedule:
    - cron: '0 * * * *' # 每小时运行一次

jobs:
  scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 这里定义并行索引，比如 1 到 3
        index: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10","11", "12", "13", "14", "15", "16", "17", "18", "19", "20"]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install playwright playwright-stealth requests
          playwright install chromium

      - name: Run Scanner
        env:
          # 读取 Secrets
          API_KEY: ${{ secrets.API_KEY }}
          TARGET_PATTERN: ${{ secrets.TARGET_PATTERN }}
          # 读取 Variables
          WORKER_VID_URL: ${{ vars.WORKER_VID_URL }}
          WORKER_TOKEN_URL: ${{ vars.WORKER_TOKEN_URL }}
          RUN_DURATION_MINUTES: ${{ vars.RUN_DURATION_MINUTES }}
          MAX_CONSECUTIVE_ERRORS: ${{ vars.MAX_CONSECUTIVE_ERRORS }}
          MAX_RETRIES: ${{ vars.MAX_RETRIES }}
          NUM_PARTS: ${{ vars.NUM_PARTS }}
          COPIES: ${{ vars.COPIES }}
        # 根据矩阵索引重命名并运行，确保切片逻辑正确
        run: |
          cp scan_vid_a.py scan_vid_a_${{ matrix.index }}.py
          python -u scan_vid_a_${{ matrix.index }}.py
