name: Sync 6dy

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch: 

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout My Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Force Sync and Repair
        run: |
          # 1. 克隆上游仓库
          git clone --depth 1 https://github.com/6dylan6/jdpro.git temp_upstream
          
          # 2. 彻底从 Git 记录中移除旧目录，防止后缀冲突
          if [ -d "function" ]; then
            git rm -rf function/
            git commit -m "Internal: cleanup for fresh sync" || true
          fi
          
          # 3. 创建新目录并拷贝
          mkdir -p function
          cp -rf temp_upstream/function/* ./function/
          
          # 4. 关键：确保所有核心文件都有 .js 后缀
          # 这样能满足 dylib 内部 require('./dyland.js') 的引用需求
          cd function
          for file in dylib dylans dyland; do
            if [ -f "$file" ]; then
              cp "$file" "$file.js"
              echo "Created $file.js from $file"
            fi
          done
          
          # 5. 打印调试信息，确认文件存在
          echo "==== Function Folder Content ===="
          ls -F
          cd ..
          
          rm -rf temp_upstream

      - name: Push Changes
        run: |
          git add function/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Fix: Sync function folder and maintain .js suffixes for internal require"
            git push origin main
