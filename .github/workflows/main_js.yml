name: VID Scanner (Node.js Version)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '触发原因 (可选)'
        required: false
        default: 'Manual triggering'
  
  repository_dispatch:
    types: [run_scanner_api]

  # schedule:
  #   - cron: '0 * * * *' 

jobs:
  scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false 
      matrix:
        index: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10",
                "11", "12", "13", "14", "15", "16", "17", "18", "19", "20"]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Run Scanner
        env:
          API_KEY: ${{ secrets.API_KEY }}
          TARGET_PATTERN: ${{ secrets.TARGET_PATTERN }}
          WORKER_VID_URL: ${{ vars.WORKER_VID_URL }}
          WORKER_TOKEN_URL: ${{ vars.WORKER_TOKEN_URL }}
          RUN_DURATION_MINUTES: ${{ vars.RUN_DURATION_MINUTES }}
          MAX_CONSECUTIVE_ERRORS: ${{ vars.MAX_CONSECUTIVE_ERRORS }}
          NUM_PARTS: ${{ vars.NUM_PARTS }}
          COPIES: ${{ vars.COPIES }}
          # 如果你在 JS 中实现了代理逻辑，可以取消注释
          # SOCKSPROXY: ${{ secrets.SOCKSPROXY }}
        run: |
          # 复制文件以满足脚本中 path.match(/(\d+)/) 的索引提取逻辑
          cp scanner.js scanner_${{ matrix.index }}.js
          node scanner_${{ matrix.index }}.js

  report:
    runs-on: ubuntu-latest
    needs: scan
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Report
        env:
          API_KEY: ${{ secrets.API_KEY }}
          WORKER_TOKEN_URL: ${{ vars.WORKER_TOKEN_URL }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: node report.js
