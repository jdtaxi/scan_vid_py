name: VID Scanner(JS Version)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '触发原因 (可选)'
        required: false
        default: 'Manual triggering'
  
  repository_dispatch:
    types: [run_scanner_api]

  # schedule:
  #   - cron: '0 * * * *' 

jobs:
  scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false 
      matrix:
        index: ["01"]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install playwright axios crypto-js got
          npx playwright install chromium --with-deps

      - name: Run Scanner
        env:
          API_KEY: ${{ secrets.API_KEY }}
          TARGET_PATTERN: ${{ secrets.TARGET_PATTERN }}
          WORKER_VID_URL: ${{ vars.WORKER_VID_URL }}
          WORKER_TOKEN_URL: ${{ vars.WORKER_TOKEN_URL }}
          RUN_DURATION_MINUTES: ${{ vars.RUN_DURATION_MINUTES }}
          MAX_CONSECUTIVE_ERRORS: ${{ vars.MAX_CONSECUTIVE_ERRORS }}
          NUM_PARTS: ${{ vars.NUM_PARTS }}
          COPIES: ${{ vars.COPIES }}
          # 如果你在 JS 中实现了代理逻辑，可以取消注释
          # SOCKSPROXY: ${{ secrets.SOCKSPROXY }}
        run: |
          # 1. 强制在当前目录创建一个声明为 commonjs 的 package.json
          # 即使你删过了，这里也要现场写一个，确保覆盖所有隐藏配置
          echo '{"type": "commonjs"}' > package.json
          
          # 2. 复制文件
          cp scan_vid_a.js scan_vid_a_${{ matrix.index }}.js
          
          # 3. 检查脚本内容，如果有 import 单词，强制注释掉或报错（防止嗅探）
          # 确保 scan_vid_a.js 里面全是 require
          
          # 4. 执行
          node scan_vid_a_${{ matrix.index }}.js

  report:
    runs-on: ubuntu-latest
    needs: scan
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Report
        env:
          API_KEY: ${{ secrets.API_KEY }}
          WORKER_TOKEN_URL: ${{ vars.WORKER_TOKEN_URL }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: node send_tg_report.js
